"use strict";
var RemovalLogin = { isFormValid: !0 };
(function ($) {
  RemovalLogin.init = function () {
    var login_form = $(".rm-login-form");
    RemovalMain.registerOnClick(login_form);
    RemovalMain.registerOnChange(login_form);
    login_form.addClass("loaded");
    var forgot_form = $(".rm-forgot-form");
    RemovalMain.registerOnClick(forgot_form);
    RemovalMain.registerOnChange(forgot_form);
    RemovalMain.registerOnClick($(".rm-reset-section-wrap"));
    $("#u_pass").on("keyup", function (e) {
      if (e.keyCode === 13) {
        $("button.rm-bt-login").trigger("click");
      }
    });
  };
  RemovalLogin.renderTab = function () {
    let action = location.search.split("action=")[1];
    if (action == "sign-up") {
      $(".rm-tabs.login").hide();
      $(".rm-tab-menu a.item.active").removeClass("active");
      $(".rm-tabs.login.active").removeClass("active");
      $(".rm-tabs.sign-up").show();
      $(".rm-tabs.sign-up").addClass("active");
      $(".rm-tab-menu a.item[data-tab='sign-up']").addClass("active");
    }
  };
  RemovalLogin.tabClick = function (self) {
    if (!self.hasClass("active")) {
      var tab = self.attr("data-tab"),
        container = self.closest(".rm-login-form"),
        tab_menu = self.closest(".rm-tab-menu"),
        current_tab = $("a.item.active", tab_menu).attr("data-tab");
      $(".rm-tabs." + current_tab).hide();
      $("a.item.active", tab_menu).removeClass("active");
      $(".rm-tabs.active", tab_menu).removeClass("active");
      $(".rm-tabs." + tab).show();
      $(this).addClass("active");
      self.addClass("active");
    }
  };
  RemovalLogin.processLoginFB = function (self) {
    RemovalMain.showProcess(self);
    FB.getLoginStatus(function (response) {
      if (response.status === "connected") {
        var accessToken = response.authResponse.accessToken,
          userID = response.authResponse.userID;
        RemovalLogin.submitLoginSocial(accessToken, userID, self);
      } else {
        FB.login(function (response) {
          var accessToken = response.authResponse.accessToken,
            userID = response.authResponse.userID;
          RemovalLogin.submitLoginSocial(accessToken, userID, self);
        });
      }
    });
  };
  RemovalLogin.submitLoginSocial = function (accessToken, userID, self) {
    $.ajax({
      url: RemovalMain.data.ajax_url,
      type: "POST",
      data: {
        action: "rm_social_login",
        accessToken: accessToken,
        userID: userID,
      },
      success: function (response) {
        response = $.parseJSON(response);
        if (
          response.result >= 0 &&
          typeof response.url != "undefined" &&
          response.url != ""
        ) {
          window.location.href = response.url;
        } else {
          RemovalMain.closeProcess(self);
          if (typeof response.message != "undefined") {
            $(".rm-login-message")
              .html(response.message)
              .removeClass("rm-hidden");
          } else {
            $(".rm-login-message")
              .html(RemovalMain.data.error_message)
              .removeClass("rm-hidden");
          }
        }
      },
      error: function () {
        RemovalMain.closeProcess(self);
        $(".rm-login-message")
          .html(RemovalMain.data.error_message)
          .removeClass("rm-hidden");
      },
    });
  };
  RemovalLogin.processLogin = function (self) {
    var return_url = new URLSearchParams(window.location.search).get(
      "return_url"
    );
    var tab = self.closest(".rm-tabs");
    RemovalMain.isFormValid = RemovalMain.validateForm($(".login .rm-form"));
    if (RemovalMain.isFormValid) {
      RemovalMain.showProcess(self);
      $(".rm-login-message", tab).html("").addClass("rm-hidden");
      $.ajax({
        url: RemovalMain.data.ajax_url,
        type: "POST",
        data: {
          action: "rm_login",
          u_email: $("#u_email", tab).val(),
          u_pass: $("#u_pass", tab).val(),
          remember_me: $("#remember_me", tab).is(":checked") ? 1 : 0,
          return_url: return_url,
          s_field: RemovalMain.data.ajax_s_field,
        },
        success: function (response) {
          response = $.parseJSON(response);
          if (
            response.result >= 0 &&
            typeof response.url != "undefined" &&
            response.url != ""
          ) {
            window.location.href = response.url;
          } else {
            RemovalMain.closeProcess(self);
            if (typeof response.message != "undefined") {
              $(".rm-login-message")
                .html(response.message)
                .removeClass("rm-hidden");
            } else {
              $(".rm-login-message")
                .html(RemovalMain.data.error_message)
                .removeClass("rm-hidden");
            }
          }
        },
        error: function () {
          RemovalMain.closeProcess(self);
          $(".rm-login-message")
            .html(RemovalMain.data.error_message)
            .removeClass("rm-hidden");
        },
      });
    }
  };
  RemovalLogin.processSignUp = function (self) {
    var tab = self.closest(".rm-tabs"),
      pass = $("#u_pass", tab).val(),
      re_pass = $("#u_re_pass", tab).val();
    RemovalMain.isFormValid = RemovalMain.validateForm($(".sign-up .rm-form"));
    if (RemovalMain.isFormValid && pass != re_pass) {
      RemovalMain.isFormValid = !1;
      $(".sign-up .rm-form .rm-re-pass").addClass("field-error");
      $(".sign-up .rm-form .rm-re-pass .field-error-message").html(
        "The password confirmation does not match"
      );
    }
    if (RemovalMain.isFormValid) {
      RemovalMain.showProcess(self);
      $.ajax({
        url: RemovalMain.data.ajax_url,
        type: "POST",
        data: {
          action: "rm_sign_up",
          u_email: $("#u_email", tab).val(),
          u_first_name: $("#u_first_name", tab).val(),
          u_last_name: $("#u_last_name", tab).val(),
          u_pass: pass,
          s_field: RemovalMain.data.ajax_s_field,
        },
        success: function (response) {
          response = $.parseJSON(response);
          RemovalMain.closeProcess(self);
          if (response.result > 0) {
            $(".rm-form,.rm-title", ".sign-up").fadeOut(function () {
              $(".rm-sign-up-notifier", ".sign-up").fadeIn();
            });
          } else {
            if (typeof response.message != "undefined") {
              $(".rm-sign-up-message")
                .html(response.message)
                .removeClass("rm-hidden");
            } else {
              $(".rm-sign-up-message")
                .html(RemovalMain.data.error_message)
                .removeClass("rm-hidden");
            }
          }
        },
        error: function () {
          RemovalMain.closeProcess(self);
          $(".rm-login-message")
            .html(RemovalMain.data.error_message)
            .removeClass("rm-hidden");
        },
      });
    }
  };
  RemovalLogin.processResetPass = function (self) {
    var container = self.closest(".rm-forgot-section-wrap");
    RemovalMain.isFormValid = RemovalMain.validateForm(
      $(".rm-forgot-form .rm-form")
    );
    if (RemovalMain.isFormValid) {
      $(".rm-forgot-message", container).html("").addClass("rm-hidden");
      RemovalMain.showProcess(self);
      $.ajax({
        url: RemovalMain.data.ajax_url,
        type: "POST",
        data: {
          action: "rm_forgot_pass",
          u_email: $("#fg_email", container).val(),
          s_field: RemovalMain.data.ajax_s_field,
        },
        success: function (response) {
          response = $.parseJSON(response);
          RemovalMain.closeProcess(self);
          if (response.result >= 0) {
            $(".rm-forgot-message")
              .html(response.message)
              .addClass("rm-main-color")
              .removeClass("rm-hidden");
          } else {
            if (typeof response.message != "undefined") {
              $(".rm-forgot-message")
                .html(response.message)
                .removeClass("rm-hidden");
            } else {
              $(".rm-forgot-message")
                .html(RemovalMain.data.error_message)
                .removeClass("rm-hidden");
            }
          }
        },
        error: function () {
          RemovalMain.closeProcess(self);
          $(".rm-login-message")
            .html(RemovalMain.data.error_message)
            .removeClass("rm-hidden");
        },
      });
    }
  };
  RemovalLogin.submitResetNewPass = function (self) {
    var container = self.closest(".rm-reset-section-wrap"),
      pass = $("#new_pass", container).val();
    if (pass != "") {
      $(".rm-forgot-message", container).html("").addClass("rm-hidden");
      RemovalMain.showProcess(self);
      $.ajax({
        url: RemovalMain.data.ajax_url,
        type: "POST",
        data: {
          action: "rm_reset_pass",
          pass: pass,
          key: $("#key", container).val(),
          login: $("#login", container).val(),
          s_field: RemovalMain.data.ajax_s_field,
        },
        success: function (response) {
          response = $.parseJSON(response);
          if (response.result >= 0 && typeof response.url != "undefined") {
            window.location.href = response.url;
          } else {
            RemovalMain.closeProcess(self);
            if (typeof response.message != "undefined") {
              $(".rm-forgot-message")
                .html(response.message)
                .addClass("rm-error")
                .removeClass("rm-hidden");
            } else {
              $(".rm-forgot-message")
                .html(RemovalMain.data.error_message)
                .addClass("rm-error")
                .removeClass("rm-hidden");
            }
          }
        },
        error: function () {
          RemovalMain.closeProcess(self);
          $(".rm-login-message")
            .html(RemovalMain.data.error_message)
            .removeClass("rm-hidden");
        },
      });
    } else {
      $(".rm-field ", container).addClass("field-error");
    }
  };
  RemovalLogin.showForgotPass = function (self) {
    $(".rm-login-section-wrap").hide();
    $(".rm-forgot-section-wrap").removeClass("rm-hidden");
  };
  RemovalLogin.googleSignInOnSuccess = function (googleUser) {
    $(".drop-image-wrapper").css("display", "flex");
    var profile = googleUser.getBasicProfile();
    var email = profile.getEmail();
    var first_name = profile.getGivenName();
    var last_name = profile.getFamilyName();
    $.ajax({
      url: RemovalMain.data.ajax_url,
      type: "POST",
      data: {
        action: "rm_google_login",
        email: email,
        first_name: first_name,
        last_name: last_name,
        s_field: RemovalMain.data.ajax_s_field,
      },
      success: function (response) {
        $(".drop-image-wrapper").css("display", "none");
        response = $.parseJSON(response);
        if (
          response.result >= 0 &&
          typeof response.url != "undefined" &&
          response.url != ""
        ) {
          window.location.href = response.url;
        } else {
          RemovalMain.closeProcess(self);
          if (typeof response.message != "undefined") {
            $(".rm-login-message")
              .html(response.message)
              .removeClass("rm-hidden");
          } else {
            $(".rm-login-message")
              .html(RemovalMain.data.error_message)
              .removeClass("rm-hidden");
          }
        }
      },
      error: function () {
        $(".drop-image-wrapper").css("display", "none");
        console.log("Login error");
      },
    });
  };
  RemovalLogin.googleSignInOnFailure = function (error) {
    console.log(error);
  };
  $(document).ready(function () {
    RemovalLogin.init();
    RemovalLogin.renderTab();
  });
})(jQuery);
